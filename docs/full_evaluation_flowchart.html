<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Full Evaluation Runner - 실행 흐름도</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8fafc;
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
        }

        header h1 {
            color: #1e293b;
            font-size: 1.75rem;
            margin-bottom: 0.5rem;
        }

        header p {
            color: #64748b;
        }

        .flowchart-container {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        svg {
            display: block;
            margin: 0 auto;
        }

        /* 범례 */
        .legend {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: #475569;
        }

        .legend-shape {
            width: 24px;
            height: 24px;
        }

        footer {
            text-align: center;
            margin-top: 2rem;
            color: #94a3b8;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>실행 흐름도</h1>
            <p>run_full_evaluation_async() 메서드의 전체 실행 과정</p>
        </header>

        <div class="flowchart-container">
            <svg width="1200" height="980" viewBox="0 0 1200 980">
                <defs>
                    <!-- 그라디언트 정의 -->
                    <linearGradient id="phaseGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#3b82f6"/>
                        <stop offset="100%" style="stop-color:#2563eb"/>
                    </linearGradient>
                    <linearGradient id="benchmarkGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#f59e0b"/>
                        <stop offset="100%" style="stop-color:#d97706"/>
                    </linearGradient>
                    <linearGradient id="reportGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#8b5cf6"/>
                        <stop offset="100%" style="stop-color:#7c3aed"/>
                    </linearGradient>
                    <linearGradient id="successGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#10b981"/>
                        <stop offset="100%" style="stop-color:#059669"/>
                    </linearGradient>
                    <linearGradient id="errorGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#ef4444"/>
                        <stop offset="100%" style="stop-color:#dc2626"/>
                    </linearGradient>

                    <!-- 화살표 마커 -->
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#64748b"/>
                    </marker>
                    <marker id="arrowhead-success" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#10b981"/>
                    </marker>
                    <marker id="arrowhead-error" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#ef4444"/>
                    </marker>

                    <!-- 그림자 필터 -->
                    <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                        <feDropShadow dx="0" dy="2" stdDeviation="3" flood-opacity="0.15"/>
                    </filter>
                </defs>

                <!-- ========== 시작 노드 ========== -->
                <g transform="translate(600, 40)">
                    <ellipse cx="0" cy="0" rx="100" ry="30" fill="#1e293b" filter="url(#shadow)"/>
                    <text x="0" y="5" text-anchor="middle" fill="white" font-size="14" font-weight="600">API 요청 수신</text>
                </g>

                <!-- 화살표: 시작 → Phase 0 -->
                <line x1="600" y1="70" x2="600" y2="100" stroke="#64748b" stroke-width="2" marker-end="url(#arrowhead)"/>

                <!-- ========== Phase 0: Leaderboard 생성 ========== -->
                <g transform="translate(600, 140)">
                    <rect x="-140" y="-35" width="280" height="70" rx="8" fill="url(#phaseGradient)" filter="url(#shadow)"/>
                    <text x="0" y="-8" text-anchor="middle" fill="white" font-size="12" font-weight="500">Phase 0</text>
                    <text x="0" y="12" text-anchor="middle" fill="white" font-size="15" font-weight="600">Leaderboard 생성</text>
                </g>

                <!-- 화살표: Phase 0 → API 호출 -->
                <line x1="600" y1="175" x2="600" y2="205" stroke="#64748b" stroke-width="2" marker-end="url(#arrowhead)"/>

                <!-- Leaderboard API 호출 -->
                <g transform="translate(600, 245)">
                    <rect x="-130" y="-30" width="260" height="60" rx="6" fill="white" stroke="#94a3b8" stroke-width="2" filter="url(#shadow)"/>
                    <text x="0" y="-5" text-anchor="middle" fill="#475569" font-size="12">leaderboard_client</text>
                    <text x="0" y="15" text-anchor="middle" fill="#1e293b" font-size="13" font-weight="600">.create_leaderboard()</text>
                </g>

                <!-- 화살표: API → Phase 1 -->
                <line x1="600" y1="275" x2="600" y2="305" stroke="#64748b" stroke-width="2" marker-end="url(#arrowhead)"/>

                <!-- ========== Phase 1: Benchmark ========== -->
                <g transform="translate(600, 350)">
                    <rect x="-140" y="-40" width="280" height="80" rx="8" fill="url(#benchmarkGradient)" filter="url(#shadow)"/>
                    <text x="0" y="-15" text-anchor="middle" fill="white" font-size="12" font-weight="500">Phase 1</text>
                    <text x="0" y="8" text-anchor="middle" fill="white" font-size="15" font-weight="600">Benchmark 실행</text>
                    <text x="0" y="26" text-anchor="middle" fill="rgba(255,255,255,0.85)" font-size="11">Toxicity + Safety (병렬)</text>
                </g>

                <!-- 화살표: Phase 1 → 판정 -->
                <line x1="600" y1="390" x2="600" y2="430" stroke="#64748b" stroke-width="2" marker-end="url(#arrowhead)"/>

                <!-- ========== Benchmark 성공 여부 판정 (마름모) ========== -->
                <g transform="translate(600, 490)">
                    <polygon points="0,-50 70,0 0,50 -70,0" fill="white" stroke="#f59e0b" stroke-width="3" filter="url(#shadow)"/>
                    <text x="0" y="-5" text-anchor="middle" fill="#1e293b" font-size="13" font-weight="600">Benchmark</text>
                    <text x="0" y="12" text-anchor="middle" fill="#1e293b" font-size="13" font-weight="600">성공?</text>
                </g>

                <!-- ===== 분기: 실패 (왼쪽) ===== -->
                <path d="M 530 490 L 350 490 L 350 560" stroke="#ef4444" stroke-width="2" fill="none" marker-end="url(#arrowhead-error)"/>
                <text x="420" y="480" text-anchor="middle" fill="#ef4444" font-size="12" font-weight="600">실패</text>

                <!-- Benchmark 실패 종료 -->
                <g transform="translate(350, 610)">
                    <rect x="-90" y="-40" width="180" height="80" rx="8" fill="url(#errorGradient)" filter="url(#shadow)"/>
                    <text x="0" y="-10" text-anchor="middle" fill="white" font-size="13" font-weight="600">status: error</text>
                    <text x="0" y="10" text-anchor="middle" fill="rgba(255,255,255,0.85)" font-size="11">benchmark_status: error</text>
                    <text x="0" y="28" text-anchor="middle" fill="rgba(255,255,255,0.85)" font-size="11">Report 건너뛰고 종료</text>
                </g>

                <!-- ===== 분기: 성공 (오른쪽) ===== -->
                <path d="M 670 490 L 850 490 L 850 560" stroke="#10b981" stroke-width="2" fill="none" marker-end="url(#arrowhead-success)"/>
                <text x="780" y="480" text-anchor="middle" fill="#10b981" font-size="12" font-weight="600">성공</text>

                <!-- Benchmark 결과 저장 -->
                <g transform="translate(850, 610)">
                    <rect x="-100" y="-40" width="200" height="80" rx="6" fill="white" stroke="#10b981" stroke-width="2" filter="url(#shadow)"/>
                    <text x="0" y="-10" text-anchor="middle" fill="#475569" font-size="12">Leaderboard 업데이트</text>
                    <text x="0" y="8" text-anchor="middle" fill="#1e293b" font-size="12" font-weight="600">benchmark_status: finished</text>
                    <text x="0" y="25" text-anchor="middle" fill="#64748b" font-size="11">benchmark_results 저장</text>
                </g>

                <!-- 화살표: 결과 저장 → Phase 2 -->
                <path d="M 850 650 L 850 700 L 600 700 L 600 730" stroke="#64748b" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>

                <!-- ========== Phase 2: Report ========== -->
                <g transform="translate(600, 780)">
                    <rect x="-140" y="-40" width="280" height="80" rx="8" fill="url(#reportGradient)" filter="url(#shadow)"/>
                    <text x="0" y="-15" text-anchor="middle" fill="white" font-size="12" font-weight="500">Phase 2</text>
                    <text x="0" y="8" text-anchor="middle" fill="white" font-size="15" font-weight="600">Report 실행 (GOAT)</text>
                    <text x="0" y="26" text-anchor="middle" fill="rgba(255,255,255,0.85)" font-size="11">대화생성 → 평가 → 보고서</text>
                </g>

                <!-- 화살표: Phase 2 → 판정 -->
                <line x1="600" y1="820" x2="600" y2="855" stroke="#64748b" stroke-width="2" marker-end="url(#arrowhead)"/>

                <!-- ========== Report 성공 여부 판정 ========== -->
                <g transform="translate(600, 905)">
                    <polygon points="0,-40 55,0 0,40 -55,0" fill="white" stroke="#8b5cf6" stroke-width="3" filter="url(#shadow)"/>
                    <text x="0" y="-5" text-anchor="middle" fill="#1e293b" font-size="12" font-weight="600">Report</text>
                    <text x="0" y="10" text-anchor="middle" fill="#1e293b" font-size="12" font-weight="600">성공?</text>
                </g>

                <!-- ===== 분기: Report 실패 ===== -->
                <path d="M 545 905 L 350 905 L 350 690" stroke="#ef4444" stroke-width="2" fill="none" marker-end="url(#arrowhead-error)"/>
                <text x="420" y="895" text-anchor="middle" fill="#ef4444" font-size="12" font-weight="600">실패</text>

                <!-- ===== 분기: Report 성공 ===== -->
                <path d="M 655 905 L 1000 905" stroke="#10b981" stroke-width="2" fill="none" marker-end="url(#arrowhead-success)"/>
                <text x="750" y="895" text-anchor="middle" fill="#10b981" font-size="12" font-weight="600">성공</text>

                <!-- ========== Phase 3: 최종 저장 ========== -->
                <g transform="translate(1050, 905)">
                    <rect x="-100" y="-45" width="200" height="90" rx="8" fill="url(#successGradient)" filter="url(#shadow)"/>
                    <text x="0" y="-20" text-anchor="middle" fill="white" font-size="12" font-weight="500">Phase 3</text>
                    <text x="0" y="0" text-anchor="middle" fill="white" font-size="14" font-weight="600">최종 결과 저장</text>
                    <text x="0" y="18" text-anchor="middle" fill="rgba(255,255,255,0.85)" font-size="11">status: finished</text>
                    <text x="0" y="33" text-anchor="middle" fill="rgba(255,255,255,0.85)" font-size="11">전체 결과 Leaderboard 저장</text>
                </g>

                <!-- ========== 우측 설명 패널 ========== -->
                <g transform="translate(80, 350)">
                    <rect x="0" y="0" width="180" height="200" rx="8" fill="#f1f5f9" stroke="#e2e8f0" stroke-width="1"/>
                    <text x="90" y="25" text-anchor="middle" fill="#475569" font-size="13" font-weight="600">Benchmark 상세</text>
                    <line x1="15" y1="38" x2="165" y2="38" stroke="#e2e8f0" stroke-width="1"/>

                    <circle cx="25" cy="60" r="6" fill="#f59e0b"/>
                    <text x="40" y="64" fill="#1e293b" font-size="11">Toxicity 평가</text>
                    <text x="40" y="78" fill="#64748b" font-size="10">- easy/medium/hard</text>
                    <text x="40" y="91" fill="#64748b" font-size="10">- 유해성 점수 (0-5)</text>

                    <circle cx="25" cy="115" r="6" fill="#f59e0b"/>
                    <text x="40" y="119" fill="#1e293b" font-size="11">Safety 평가</text>
                    <text x="40" y="133" fill="#64748b" font-size="10">- easy/medium/hard</text>
                    <text x="40" y="146" fill="#64748b" font-size="10">- SAFE/UNSAFE</text>

                    <circle cx="25" cy="170" r="6" fill="#f59e0b"/>
                    <text x="40" y="174" fill="#1e293b" font-size="11">ThreadPoolExecutor</text>
                    <text x="40" y="188" fill="#64748b" font-size="10">- 병렬 처리</text>
                </g>

                <g transform="translate(80, 700)">
                    <rect x="0" y="0" width="180" height="160" rx="8" fill="#f1f5f9" stroke="#e2e8f0" stroke-width="1"/>
                    <text x="90" y="25" text-anchor="middle" fill="#475569" font-size="13" font-weight="600">Report 상세</text>
                    <line x1="15" y1="38" x2="165" y2="38" stroke="#e2e8f0" stroke-width="1"/>

                    <circle cx="25" cy="60" r="6" fill="#8b5cf6"/>
                    <text x="40" y="64" fill="#1e293b" font-size="11">core_main()</text>
                    <text x="40" y="78" fill="#64748b" font-size="10">- 시나리오 대화 생성</text>

                    <circle cx="25" cy="100" r="6" fill="#8b5cf6"/>
                    <text x="40" y="104" fill="#1e293b" font-size="11">evaluate_dialogues()</text>
                    <text x="40" y="118" fill="#64748b" font-size="10">- 턴별 윤리성 평가</text>

                    <circle cx="25" cy="140" r="6" fill="#8b5cf6"/>
                    <text x="40" y="144" fill="#1e293b" font-size="11">generate_reports()</text>
                    <text x="40" y="158" fill="#64748b" font-size="10">- 개별/전체 보고서</text>
                </g>

            </svg>
        </div>

        <div class="legend">
            <div class="legend-item">
                <svg class="legend-shape" viewBox="0 0 24 24">
                    <ellipse cx="12" cy="12" rx="10" ry="8" fill="#1e293b"/>
                </svg>
                <span>시작/종료</span>
            </div>
            <div class="legend-item">
                <svg class="legend-shape" viewBox="0 0 24 24">
                    <rect x="2" y="4" width="20" height="16" rx="3" fill="#3b82f6"/>
                </svg>
                <span>Phase (단계)</span>
            </div>
            <div class="legend-item">
                <svg class="legend-shape" viewBox="0 0 24 24">
                    <rect x="2" y="4" width="20" height="16" rx="2" fill="white" stroke="#94a3b8" stroke-width="2"/>
                </svg>
                <span>처리/API 호출</span>
            </div>
            <div class="legend-item">
                <svg class="legend-shape" viewBox="0 0 24 24">
                    <polygon points="12,2 22,12 12,22 2,12" fill="white" stroke="#f59e0b" stroke-width="2"/>
                </svg>
                <span>조건 분기</span>
            </div>
            <div class="legend-item">
                <svg class="legend-shape" viewBox="0 0 24 24">
                    <line x1="4" y1="12" x2="20" y2="12" stroke="#10b981" stroke-width="3"/>
                </svg>
                <span>성공 흐름</span>
            </div>
            <div class="legend-item">
                <svg class="legend-shape" viewBox="0 0 24 24">
                    <line x1="4" y1="12" x2="20" y2="12" stroke="#ef4444" stroke-width="3"/>
                </svg>
                <span>실패 흐름</span>
            </div>
        </div>

        <footer>
            <p>full_evaluation_runner.py | api-server-v2</p>
        </footer>
    </div>
</body>
</html>
